name: Compile LaTeX
on: [ push ]
jobs:
  compile-all-tex:
    runs-on: ubuntu-latest
    container: kjarosh/latex:2024.4
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create output directory
        run: mkdir -p output

      - name: Find and compile all .tex files
        run: |
          echo "Finding all .tex files in repository..."
          find . -name "*.tex" -type f | while read -r texfile; do
            echo "Compiling: $texfile"
            # Get the filename without path and extension
            filename=$(basename "$texfile" .tex)
            # Compile the file
            latexmk -pdf -interaction=nonstopmode -output-directory=output "$texfile" || echo "Warning: Failed to compile $texfile"
            # Rename output to include original path structure
            if [ -f "output/${filename}.pdf" ]; then
              # Create subdirectory structure in output/
              dir=$(dirname "$texfile" | sed 's/^\.\///')
              if [ "$dir" != "." ]; then
                mkdir -p "output/$dir"
                mv "output/${filename}.pdf" "output/${dir}/${filename}.pdf"
              fi
              echo "Successfully compiled: $texfile -> output/${dir}/${filename}.pdf"
            fi
          done
          echo "Compilation complete. Listing all PDFs:"
          find output -name "*.pdf" -type f

      - name: Commit and push PDFs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/
          git diff --cached --quiet || (git commit -m "Auto-compile LaTeX documents to PDF" && git push)

      - name: Upload all compiled PDFs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-compiled-documents
          path: output/**/*.pdf
          if-no-files-found: warn